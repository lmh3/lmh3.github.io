---
layout: post
title: MySQL索引
categories: MySQL
tags:
- MySQL
description : 索引
---


### 一、什么是索引

MySQL索引的定义：索引（Index）是帮助MySQL高效获取数据的数据结构。

MySQL结构图：

![MySql-System](/images/mysqlSys.JPG)

第一层：链接处理、授权认证、安全等。

第二层：MySQL核心服务：查询解析、优化、缓存、存储过程、触发器、视图等。

第三层：存储引擎，负责MySQL数据的存储和提取。


索引由存储引擎层次实现。所以MySQL的索引是有多种实现的。

数据库查询是数据库的最主要功能之一。每种查找算法都只能应用于特定的数据结构之上，例如二分查找要求被检索数据有序，而二叉树查找只能应用于二叉查找树上，但是数据本身的组织结构不可能完全满足各种数据结构（例如，理论上不可能同时将两列都按顺序进行组织），所以，在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。

### 二、索引分类

#### B+Tree索引

目前大部分数据库系统及文件系统都采用B-Tree或其变种B+Tree作为索引结构。

*B+Tree是什么？*

![btree](/images/btree.png)

多叉平衡查找树，结构:

```
高度为h, 度数为t (t>=2)
每个非叶子节点由n-1个key和n个指针组成，其中t<=n<=2t。
每个叶子节点最少包含一个key，最多包含2d-1个key。
一个节点中的key从左到右非递减排列。
所以的叶子节点具有相同的高度。
叶子节点的中，存在指向下一个叶子节点的指针
非叶子节点之存储关键字，数据都存储在叶子节点中
```

*为啥是B+Tree*

一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。这样的话，索引查找过程中就要产生磁盘I/O消耗，相对于内存存取，I/O存取的消耗要高几个数量级，所以评价一个数据结构作为索引的优劣最重要的指标就是在查找过程中磁盘I/O操作次数。

CPU以页为单位从磁盘获取数据，页大小默认为16k。所以数的高度直接决定了磁盘IO的次数。一般实际应用中，出度d是非常大的数字，因此h非常小。而红黑树等二叉树的h要大的多。

*B+Tree索引特点：*

* 支持全值匹配（所有列）
* 支持匹配最左前缀（索引的前若干列）
* 支持匹配列前缀 （列值的开头部分）
* 支持匹配范围值
* 只访问索引的查询，无需访问数据行
* 支持排序查找
* 多列索引必须从最左列开始，无法跳过某一列。
* 如果某个列是范围查询，则右边的列不能使用索引。


#### 哈希索引

基于hash表实现，存储引擎会对索引列计算已个hashCode。

MySQL中Memory引擎支持哈希索引。

* 访问数据非常快。
* 哈希索引数据不会按照索引值顺序存储的，无法排序。
* 只能精确匹配索引所有列才有效，不支持部分索引列匹配。
* 只支持等值查询，不支持范围查询。
* 索引只包含哈希值和行指针，不存储字段值，不能避免读取行。

#### 空间数据索引（R-Tree）

MyISAM支持空间索引，用作地理数据存储。

#### 全文索引
MyISAM支持全文索引。索引分两层，第一层是所有的关键字，第二层是每个关键字对应的文档指针。
全文索引适用于match against操作，而不是where条件操作。

### 三、MyISAM和InnoDB索引实现的区别

![index](/images/jvchuindex.png)

#### MyISAM

* 非聚簇，数据与索引分开存放
* 索引中值为数据的行号
* 使用前缀压缩技术，使得索引更小

#### InnoDB
* 聚簇索引，主键索引中存放的值是数据行的所有数据。
* 非主键索引中的值是对应的主键值，索引需要查找两次。
* 如果没有主键，会选择一个唯一非空索引代替。如果这个也没有，会隐式定义一个主键作为聚簇索引。

### 四、高效索引
* 独立的列：索引列不能是表达式的一部分或者函数的参数。
* 前缀索引，只索引字段的部分，但注意保证较高的选择性。
* 多列索引优于多个单列索引，选择合适的索引列顺序。 
* 覆盖索引。
* 去除冗余和重复索引。
